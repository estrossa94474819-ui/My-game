<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Ø²ÙˆÙ…Ø¨ÙŠ Ø´ÙˆØªØ±</title>
<style>
  :root{--ui:#14b8a6;--bg:#0b1020;--panel:#121a30;--text:#eaf2ff;}
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Arial;}
  #game{display:block;width:100vw;height:100vh;background:#0a0f1d;touch-action:none;}
  /* Ø·Ø¨Ù‚Ø§Øª ÙˆØ§Ø¬Ù‡Ø© */
  .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:5}
  .card{background:var(--panel);border:1px solid #26324d;border-radius:16px;padding:22px;min-width:280px;max-width:92vw;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .title{font-size:26px;margin:0 0 10px}
  .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
  .btn{cursor:pointer;border:none;border-radius:14px;padding:12px 16px;font-weight:700;font-size:16px;background:var(--ui);color:#002529;box-shadow:inset 0 -3px 0 rgba(0,0,0,.2)}
  .btn.secondary{background:#334155;color:#dbeafe}
  .small{font-size:13px;opacity:.85}
  .hidden{display:none !important;}

  /* HUD */
  #hud{position:fixed;left:10px;top:10px;z-index:3;font-weight:700;text-shadow:0 1px 0 #000}
  #hud .pill{display:inline-block;background:#0b1328cc;border:1px solid #21304d;border-radius:999px;padding:6px 12px;margin-inline-end:6px}
  #health{display:inline-flex;gap:6px;vertical-align:middle}
  .heart{width:14px;height:14px;display:inline-block;background:#ef4444;border-radius:3px;box-shadow:0 0 6px #ef4444aa}

  /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù„Ù…Ø³ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø§Ø´Ø© */
  #controls{position:fixed;inset:auto 0 10px 0;display:flex;justify-content:space-between;align-items:flex-end;padding:0 12px;z-index:4;pointer-events:none}
  .dpad{pointer-events:auto;display:grid;grid-template-columns:64px 64px 64px;grid-template-rows:64px 64px;gap:10px}
  .dpad .round{width:64px;height:64px;border-radius:50%;background:#1f2937;border:1px solid #334155;color:#e5e7eb;font-size:22px;font-weight:900;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 20px rgba(0,0,0,.25)}
  .dpad .up{grid-column:2;grid-row:1}
  .dpad .left{grid-column:1;grid-row:2}
  .dpad .down{grid-column:2;grid-row:2}
  .dpad .right{grid-column:3;grid-row:2}
  .fireWrap{pointer-events:auto;display:flex;gap:10px;align-items:flex-end}
  .fire{width:84px;height:84px;border-radius:50%;background:radial-gradient(circle at 30% 30%, #ffd54a, #f97316);border:none;color:#111;font-size:18px;font-weight:900;box-shadow:0 12px 28px rgba(249,115,22,.45)}
  .btn:active,.round:active,.fire:active{transform:translateY(1px)}
  /* Ù…Ù†Ø¹ Ø³Ø­Ø¨ Ø§Ù„ØµÙØ­Ø© */
  body, #controls, .round, .fire {touch-action:none;}
</style>
</head>
<body>

<canvas id="game"></canvas>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© -->
<div id="menu" class="overlay">
  <div class="card">
    <h1 class="title">Ø²ÙˆÙ…Ø¨ÙŠ Ø´ÙˆØªØ±</h1>
    <p>Ø§Ø®ØªØ± Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹ÙˆØ¨Ø©</p>
    <div class="row">
      <button class="btn" id="easyBtn">Ø³Ù‡Ù„</button>
      <button class="btn" id="hardBtn">ØµØ¹Ø¨</button>
    </div>
    <p class="small" style="margin-top:14px">ØªØ­ÙƒÙ‘Ù…: Ø§Ù„Ø£Ø³Ù‡Ù…/â€WASD + Space â€” Ø£Ùˆ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©</p>
  </div>
</div>

<!-- HUD -->
<div id="hud" class="hidden">
  <span class="pill">Ø§Ù„Ù…Ø±Ø­Ù„Ø©: <b id="lvl">1</b>/5</span>
  <span class="pill">Ø§Ù„Ù†Ù‚Ø§Ø·: <b id="score">0</b></span>
  <span class="pill">ØªÙ… Ù‚ØªÙ„: <b id="kills">0</b></span>
  <span class="pill">Ø§Ù„ØµØ­Ø©: <span id="health"></span></span>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© -->
<div id="gameover" class="overlay hidden">
  <div class="card">
    <h2 class="title" id="overTitle">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
    <p class="small" id="overStats"></p>
    <div class="row">
      <button class="btn" id="retryBtn">Ø¥Ø¹Ø§Ø¯Ø©</button>
      <button class="btn secondary" id="menuBtn">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
    </div>
  </div>
</div>

<!-- Ø£Ø²Ø±Ø§Ø± Ù„Ù…Ø³ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø§Ø´Ø© -->
<div id="controls" class="hidden">
  <div class="dpad">
    <button class="round up"    data-hold="up">â–²</button>
    <button class="round left"  data-hold="left">â—€</button>
    <button class="round down"  data-hold="down">â–¼</button>
    <button class="round right" data-hold="right">â–¶</button>
  </div>
  <div class="fireWrap">
    <button class="fire" id="btnShoot">Ø¥Ø·Ù„Ø§Ù‚</button>
  </div>
</div>

<script>
(() => {
  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d');

  // ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù„ÙˆØ­Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
  function resize(){ cvs.width = window.innerWidth; cvs.height = window.innerHeight; }
  window.addEventListener('resize', resize, {passive:true}); resize();

  // Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
  const state = {
    running:false, mode:'easy',
    level:1, maxLevels:5,
    score:0, kills:0,
    healthMax:3, health:3,
    spawnEvery:110, // Ø¥Ø·Ø§Ø±
    zombieBaseSpeed:1.2,
    lastTime:0, acc:0
  };

  // ÙƒØ§Ø¦Ù†Ø§Øª
  let player, bullets=[], zombies=[];
  const keys = {left:false,right:false,up:false,down:false,shoot:false};

  function resetPlayer(){
    player = {x:cvs.width/2-18, y:cvs.height-110, w:36, h:36, speed:4.2, fireCd:0};
  }

  function setMode(mode){
    state.mode = mode;
    if(mode==='hard'){ state.spawnEvery=70; state.zombieBaseSpeed=1.6; }
    else { state.spawnEvery=110; state.zombieBaseSpeed=1.2; }
  }

  function startGame(){
    state.running = true;
    state.level = 1;
    state.score = 0;
    state.kills = 0;
    state.health = state.healthMax;
    bullets.length = 0; zombies.length = 0;
    resetPlayer();
    renderHearts();
    document.getElementById('menu').classList.add('hidden');
    document.getElementById('gameover').classList.add('hidden');
    document.getElementById('controls').classList.remove('hidden');
    document.getElementById('hud').classList.remove('hidden');
    state.lastTime = performance.now();
    requestAnimationFrame(loop);
  }

  function endGame(win=false){
    state.running = false;
    document.getElementById('controls').classList.add('hidden');
    const t = document.getElementById('overTitle');
    t.textContent = win ? 'ÙØ²Øª! ğŸ‰' : 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©';
    document.getElementById('overStats').textContent =
      `Ø§Ù„Ù†Ù‚Ø§Ø·: ${state.score} â€” ØªÙ… Ù‚ØªÙ„: ${state.kills} â€” Ø§Ù„Ù…Ø±Ø­Ù„Ø©: ${state.level}/${state.maxLevels}`;
    document.getElementById('gameover').classList.remove('hidden');
  }

  // ØªÙˆÙ„ÙŠØ¯ Ø²ÙˆÙ…Ø¨ÙŠ
  let spawnTimer=0;
  function spawnZombie(){
    const size = 26 + Math.random()*12;
    const x = Math.random()*(cvs.width-size);
    const y = -size - 10;
    const sp = state.zombieBaseSpeed + (state.level-1)*0.35 + Math.random()*0.4;
    const hp = (state.mode==='hard'?2:1) + (state.level>3?1:0);
    zombies.push({x,y,w:size,h:size, vy:sp, hp});
  }

  // Ù‚Ù„ÙˆØ¨ Ø§Ù„ØµØ­Ø©
  function renderHearts(){
    const h = document.getElementById('health');
    h.innerHTML = '';
    for(let i=0;i<state.health;i++){
      const e = document.createElement('span'); e.className='heart'; h.appendChild(e);
    }
  }

  // HUD
  function updateHud(){
    document.getElementById('lvl').textContent = state.level;
    document.getElementById('score').textContent = state.score;
    document.getElementById('kills').textContent = state.kills;
  }

  // ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù„Ø§Ø¹Ø¨
  function movePlayer(dt){
    const s = player.speed * dt * 60;
    if(keys.left)  player.x -= s;
    if(keys.right) player.x += s;
    if(keys.up)    player.y -= s;
    if(keys.down)  player.y += s;
    // Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø´Ø§Ø´Ø©
    player.x = Math.max(0, Math.min(cvs.width - player.w, player.x));
    player.y = Math.max(0, Math.min(cvs.height - player.h, player.y));
  }

  // Ø¥Ø·Ù„Ø§Ù‚
  function tryShoot(dt){
    if(player.fireCd>0){ player.fireCd -= dt; return; }
    if(keys.shoot){
      bullets.push({x:player.x+player.w/2-4, y:player.y-8, w:8, h:14, vy:-9});
      player.fireCd = (state.mode==='hard'?0.18:0.22); // Ø«Ø§Ù†ÙŠØ©
    }
  }

  // Ù…Ø³ØªØ·ÙŠÙ„Ø§Øª ØªØªÙ‚Ø§Ø·Ø¹ØŸ
  function hit(a,b){ return !(a.x+a.w<b.x || a.x>b.x+b.w || a.y+a.h<b.y || a.y>b.y+b.h); }

  // Ø­Ù„Ù‚Ø© Ø§Ù„Ø±Ø³Ù…/Ø§Ù„ØªØ­Ø¯ÙŠØ«
  function loop(t){
    if(!state.running) return;
    const dt = Math.min(0.033, (t - state.lastTime)/1000); // ~30fps cap Ø¹Ù„Ù‰ dt
    state.lastTime = t;

    // Ø®Ù„ÙÙŠØ© Ù†Ø¬ÙˆÙ… Ø¨Ø³ÙŠØ·Ø©
    ctx.clearRect(0,0,cvs.width,cvs.height);
    ctx.fillStyle = '#070d1a';
    ctx.fillRect(0,0,cvs.width,cvs.height);
    ctx.fillStyle = '#9ca3af22';
    for(let i=0;i<45;i++){ ctx.fillRect((i*53)%cvs.width, (i*97 + t*0.02)%cvs.height, 2,2); }

    movePlayer(dt);
    tryShoot(dt);

    // ØªÙˆÙ„ÙŠØ¯ Ø£Ø¹Ø¯Ø§Ø¡
    spawnTimer += dt * 60;
    const every = Math.max(24, state.spawnEvery - (state.level-1)*10);
    if(spawnTimer >= every){ spawnTimer = 0; spawnZombie(); }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµØ§Øµ
    ctx.fillStyle = '#facc15';
    for(let i=bullets.length-1;i>=0;i--){
      const b = bullets[i]; b.y += b.vy;
      ctx.fillRect(b.x,b.y,b.w,b.h);
      if(b.y + b.h < 0) bullets.splice(i,1);
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²ÙˆÙ…Ø¨ÙŠ
    ctx.fillStyle = '#ef4444';
    for(let i=zombies.length-1;i>=0;i--){
      const z = zombies[i];
      z.y += z.vy;
      ctx.fillRect(z.x,z.y,z.w,z.h);

      // Ø§ØµØ·Ø¯Ø§Ù… Ù…Ø¹ Ø§Ù„Ù„Ø§Ø¹Ø¨
      if(hit(z,player)){
        zombies.splice(i,1);
        state.health -= 1;
        renderHearts();
        if(state.health<=0){ updateHud(); return endGame(false); }
        continue;
      }

      // Ø§ØµØ·Ø¯Ø§Ù… Ù…Ø¹ Ø±ØµØ§ØµØ©
      for(let j=bullets.length-1;j>=0;j--){
        const b = bullets[j];
        if(hit(z,b)){
          bullets.splice(j,1);
          z.hp -= 1;
          if(z.hp<=0){
            zombies.splice(i,1);
            state.kills++; state.score += 10;
          }
          break;
        }
      }

      // Ø®Ø±Ø¬ Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø©
      if(z && z.y>cvs.height+40) zombies.splice(i,1);
    }

    // Ø±Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨
    ctx.fillStyle = '#22c55e';
    ctx.fillRect(player.x,player.y,player.w,player.h);
    // ÙÙˆÙ‡Ø©
    ctx.fillStyle = '#16a34a';
    ctx.fillRect(player.x+player.w/2-4, player.y-6, 8,6);

    // Ø§Ù„ØªØ¯Ø±Ù‘Ø¬ Ø¨Ø§Ù„Ù…Ø±Ø§Ø­Ù„
    const targetKills = state.level * 8; // ÙƒÙ„ Ù…Ø±Ø­Ù„Ø© 8 Ù‚ØªÙ„Ø§Øª
    if(state.kills >= targetKills){
      if(state.level >= state.maxLevels){
        updateHud();
        return endGame(true);
      }
      state.level++;
      // Ø¯ÙØ¹Ø© ØµØ¹ÙˆØ¨Ø© Ø¨Ø³ÙŠØ·Ø©
      state.zombieBaseSpeed += 0.25;
      // Ø´ÙØ§Ø¡ Ø¨Ø³ÙŠØ·
      state.health = Math.min(state.healthMax, state.health+1);
      renderHearts();
    }

    updateHud();
    requestAnimationFrame(loop);
  }

  // Ø¥Ø¯Ø®Ø§Ù„ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
  const down = e=>{
    if(['ArrowLeft','a','A'].includes(e.key))  keys.left=true;
    if(['ArrowRight','d','D'].includes(e.key)) keys.right=true;
    if(['ArrowUp','w','W'].includes(e.key))    keys.up=true;
    if(['ArrowDown','s','S'].includes(e.key))  keys.down=true;
    if(e.code==='Space') keys.shoot=true;
  };
  const up = e=>{
    if(['ArrowLeft','a','A'].includes(e.key))  keys.left=false;
    if(['ArrowRight','d','D'].includes(e.key)) keys.right=false;
    if(['ArrowUp','w','W'].includes(e.key))    keys.up=false;
    if(['ArrowDown','s','S'].includes(e.key))  keys.down=false;
    if(e.code==='Space') keys.shoot=false;
  };
  window.addEventListener('keydown', down);
  window.addEventListener('keyup', up);

  // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù„Ù…Ø³
  function bindHold(el, prop){
    const set = v=>{ keys[prop]=v; };
    const on = e=>{ e.preventDefault(); set(true); };
    const off = e=>{ e.preventDefault(); set(false); };
    el.addEventListener('pointerdown', on);
    el.addEventListener('pointerup', off);
    el.addEventListener('pointercancel', off);
    el.addEventListener('pointerleave', off);
  }
  document.querySelectorAll('[data-hold]')
    .forEach(b=>bindHold(b, b.dataset.hold));
  // Ø²Ø± Ø¥Ø·Ù„Ø§Ù‚
  const fireBtn = document.getElementById('btnShoot');
  bindHold(fireBtn, 'shoot');

  // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©/Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø©
  document.getElementById('easyBtn').onclick = ()=>{ setMode('easy'); startGame(); };
  document.getElementById('hardBtn').onclick = ()=>{ setMode('hard'); startGame(); };
  document.getElementById('retryBtn').onclick = ()=> startGame();
  document.getElementById('menuBtn').onclick  = ()=>{
    document.getElementById('controls').classList.add('hidden');
    document.getElementById('hud').classList.add('hidden');
    document.getElementById('gameover').classList.add('hidden');
    document.getElementById('menu').classList.remove('hidden');
  };

  // Ù…Ù†Ø¹ Ø³Ø­Ø¨ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„Ø¥ÙŠÙ…Ø§Ø¡Ø§Øª
  ['touchstart','touchmove'].forEach(ev=>{
    document.body.addEventListener(ev, e=>{ if(e.target.closest('#controls')) e.preventDefault(); }, {passive:false});
  });
})();
</script>
</body>
</html>
