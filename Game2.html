<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>زومبي شوتر</title>
<style>
  :root{--ui:#14b8a6;--bg:#0b1020;--panel:#121a30;--text:#eaf2ff;}
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Arial;}
  #game{display:block;width:100vw;height:100vh;background:#0a0f1d;touch-action:none;}
  /* طبقات واجهة */
  .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:5}
  .card{background:var(--panel);border:1px solid #26324d;border-radius:16px;padding:22px;min-width:280px;max-width:92vw;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .title{font-size:26px;margin:0 0 10px}
  .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
  .btn{cursor:pointer;border:none;border-radius:14px;padding:12px 16px;font-weight:700;font-size:16px;background:var(--ui);color:#002529;box-shadow:inset 0 -3px 0 rgba(0,0,0,.2)}
  .btn.secondary{background:#334155;color:#dbeafe}
  .small{font-size:13px;opacity:.85}
  .hidden{display:none !important;}

  /* HUD */
  #hud{position:fixed;left:10px;top:10px;z-index:3;font-weight:700;text-shadow:0 1px 0 #000}
  #hud .pill{display:inline-block;background:#0b1328cc;border:1px solid #21304d;border-radius:999px;padding:6px 12px;margin-inline-end:6px}
  #health{display:inline-flex;gap:6px;vertical-align:middle}
  .heart{width:14px;height:14px;display:inline-block;background:#ef4444;border-radius:3px;box-shadow:0 0 6px #ef4444aa}

  /* أزرار اللمس داخل الشاشة */
  #controls{position:fixed;inset:auto 0 10px 0;display:flex;justify-content:space-between;align-items:flex-end;padding:0 12px;z-index:4;pointer-events:none}
  .dpad{pointer-events:auto;display:grid;grid-template-columns:64px 64px 64px;grid-template-rows:64px 64px;gap:10px}
  .dpad .round{width:64px;height:64px;border-radius:50%;background:#1f2937;border:1px solid #334155;color:#e5e7eb;font-size:22px;font-weight:900;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 20px rgba(0,0,0,.25)}
  .dpad .up{grid-column:2;grid-row:1}
  .dpad .left{grid-column:1;grid-row:2}
  .dpad .down{grid-column:2;grid-row:2}
  .dpad .right{grid-column:3;grid-row:2}
  .fireWrap{pointer-events:auto;display:flex;gap:10px;align-items:flex-end}
  .fire{width:84px;height:84px;border-radius:50%;background:radial-gradient(circle at 30% 30%, #ffd54a, #f97316);border:none;color:#111;font-size:18px;font-weight:900;box-shadow:0 12px 28px rgba(249,115,22,.45)}
  .btn:active,.round:active,.fire:active{transform:translateY(1px)}
  /* منع سحب الصفحة */
  body, #controls, .round, .fire {touch-action:none;}
</style>
</head>
<body>

<canvas id="game"></canvas>

<!-- شاشة القائمة -->
<div id="menu" class="overlay">
  <div class="card">
    <h1 class="title">زومبي شوتر</h1>
    <p>اختر مستوى الصعوبة</p>
    <div class="row">
      <button class="btn" id="easyBtn">سهل</button>
      <button class="btn" id="hardBtn">صعب</button>
    </div>
    <p class="small" style="margin-top:14px">تحكّم: الأسهم/‏WASD + Space — أو الأزرار على الشاشة</p>
  </div>
</div>

<!-- HUD -->
<div id="hud" class="hidden">
  <span class="pill">المرحلة: <b id="lvl">1</b>/5</span>
  <span class="pill">النقاط: <b id="score">0</b></span>
  <span class="pill">تم قتل: <b id="kills">0</b></span>
  <span class="pill">الصحة: <span id="health"></span></span>
</div>

<!-- شاشة النهاية -->
<div id="gameover" class="overlay hidden">
  <div class="card">
    <h2 class="title" id="overTitle">انتهت اللعبة</h2>
    <p class="small" id="overStats"></p>
    <div class="row">
      <button class="btn" id="retryBtn">إعادة</button>
      <button class="btn secondary" id="menuBtn">القائمة</button>
    </div>
  </div>
</div>

<!-- أزرار لمس داخل الشاشة -->
<div id="controls" class="hidden">
  <div class="dpad">
    <button class="round up"    data-hold="up">▲</button>
    <button class="round left"  data-hold="left">◀</button>
    <button class="round down"  data-hold="down">▼</button>
    <button class="round right" data-hold="right">▶</button>
  </div>
  <div class="fireWrap">
    <button class="fire" id="btnShoot">إطلاق</button>
  </div>
</div>

<script>
(() => {
  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d');

  // تكبير اللوحة تلقائيًا
  function resize(){ cvs.width = window.innerWidth; cvs.height = window.innerHeight; }
  window.addEventListener('resize', resize, {passive:true}); resize();

  // حالة اللعبة
  const state = {
    running:false, mode:'easy',
    level:1, maxLevels:5,
    score:0, kills:0,
    healthMax:3, health:3,
    spawnEvery:110, // إطار
    zombieBaseSpeed:1.2,
    lastTime:0, acc:0
  };

  // كائنات
  let player, bullets=[], zombies=[];
  const keys = {left:false,right:false,up:false,down:false,shoot:false};

  function resetPlayer(){
    player = {x:cvs.width/2-18, y:cvs.height-110, w:36, h:36, speed:4.2, fireCd:0};
  }

  function setMode(mode){
    state.mode = mode;
    if(mode==='hard'){ state.spawnEvery=70; state.zombieBaseSpeed=1.6; }
    else { state.spawnEvery=110; state.zombieBaseSpeed=1.2; }
  }

  function startGame(){
    state.running = true;
    state.level = 1;
    state.score = 0;
    state.kills = 0;
    state.health = state.healthMax;
    bullets.length = 0; zombies.length = 0;
    resetPlayer();
    renderHearts();
    document.getElementById('menu').classList.add('hidden');
    document.getElementById('gameover').classList.add('hidden');
    document.getElementById('controls').classList.remove('hidden');
    document.getElementById('hud').classList.remove('hidden');
    state.lastTime = performance.now();
    requestAnimationFrame(loop);
  }

  function endGame(win=false){
    state.running = false;
    document.getElementById('controls').classList.add('hidden');
    const t = document.getElementById('overTitle');
    t.textContent = win ? 'فزت! 🎉' : 'انتهت اللعبة';
    document.getElementById('overStats').textContent =
      `النقاط: ${state.score} — تم قتل: ${state.kills} — المرحلة: ${state.level}/${state.maxLevels}`;
    document.getElementById('gameover').classList.remove('hidden');
  }

  // توليد زومبي
  let spawnTimer=0;
  function spawnZombie(){
    const size = 26 + Math.random()*12;
    const x = Math.random()*(cvs.width-size);
    const y = -size - 10;
    const sp = state.zombieBaseSpeed + (state.level-1)*0.35 + Math.random()*0.4;
    const hp = (state.mode==='hard'?2:1) + (state.level>3?1:0);
    zombies.push({x,y,w:size,h:size, vy:sp, hp});
  }

  // قلوب الصحة
  function renderHearts(){
    const h = document.getElementById('health');
    h.innerHTML = '';
    for(let i=0;i<state.health;i++){
      const e = document.createElement('span'); e.className='heart'; h.appendChild(e);
    }
  }

  // HUD
  function updateHud(){
    document.getElementById('lvl').textContent = state.level;
    document.getElementById('score').textContent = state.score;
    document.getElementById('kills').textContent = state.kills;
  }

  // تحريك اللاعب
  function movePlayer(dt){
    const s = player.speed * dt * 60;
    if(keys.left)  player.x -= s;
    if(keys.right) player.x += s;
    if(keys.up)    player.y -= s;
    if(keys.down)  player.y += s;
    // حدود الشاشة
    player.x = Math.max(0, Math.min(cvs.width - player.w, player.x));
    player.y = Math.max(0, Math.min(cvs.height - player.h, player.y));
  }

  // إطلاق
  function tryShoot(dt){
    if(player.fireCd>0){ player.fireCd -= dt; return; }
    if(keys.shoot){
      bullets.push({x:player.x+player.w/2-4, y:player.y-8, w:8, h:14, vy:-9});
      player.fireCd = (state.mode==='hard'?0.18:0.22); // ثانية
    }
  }

  // مستطيلات تتقاطع؟
  function hit(a,b){ return !(a.x+a.w<b.x || a.x>b.x+b.w || a.y+a.h<b.y || a.y>b.y+b.h); }

  // حلقة الرسم/التحديث
  function loop(t){
    if(!state.running) return;
    const dt = Math.min(0.033, (t - state.lastTime)/1000); // ~30fps cap على dt
    state.lastTime = t;

    // خلفية نجوم بسيطة
    ctx.clearRect(0,0,cvs.width,cvs.height);
    ctx.fillStyle = '#070d1a';
    ctx.fillRect(0,0,cvs.width,cvs.height);
    ctx.fillStyle = '#9ca3af22';
    for(let i=0;i<45;i++){ ctx.fillRect((i*53)%cvs.width, (i*97 + t*0.02)%cvs.height, 2,2); }

    movePlayer(dt);
    tryShoot(dt);

    // توليد أعداء
    spawnTimer += dt * 60;
    const every = Math.max(24, state.spawnEvery - (state.level-1)*10);
    if(spawnTimer >= every){ spawnTimer = 0; spawnZombie(); }

    // تحديث الرصاص
    ctx.fillStyle = '#facc15';
    for(let i=bullets.length-1;i>=0;i--){
      const b = bullets[i]; b.y += b.vy;
      ctx.fillRect(b.x,b.y,b.w,b.h);
      if(b.y + b.h < 0) bullets.splice(i,1);
    }

    // تحديث الزومبي
    ctx.fillStyle = '#ef4444';
    for(let i=zombies.length-1;i>=0;i--){
      const z = zombies[i];
      z.y += z.vy;
      ctx.fillRect(z.x,z.y,z.w,z.h);

      // اصطدام مع اللاعب
      if(hit(z,player)){
        zombies.splice(i,1);
        state.health -= 1;
        renderHearts();
        if(state.health<=0){ updateHud(); return endGame(false); }
        continue;
      }

      // اصطدام مع رصاصة
      for(let j=bullets.length-1;j>=0;j--){
        const b = bullets[j];
        if(hit(z,b)){
          bullets.splice(j,1);
          z.hp -= 1;
          if(z.hp<=0){
            zombies.splice(i,1);
            state.kills++; state.score += 10;
          }
          break;
        }
      }

      // خرج من الشاشة
      if(z && z.y>cvs.height+40) zombies.splice(i,1);
    }

    // رسم اللاعب
    ctx.fillStyle = '#22c55e';
    ctx.fillRect(player.x,player.y,player.w,player.h);
    // فوهة
    ctx.fillStyle = '#16a34a';
    ctx.fillRect(player.x+player.w/2-4, player.y-6, 8,6);

    // التدرّج بالمراحل
    const targetKills = state.level * 8; // كل مرحلة 8 قتلات
    if(state.kills >= targetKills){
      if(state.level >= state.maxLevels){
        updateHud();
        return endGame(true);
      }
      state.level++;
      // دفعة صعوبة بسيطة
      state.zombieBaseSpeed += 0.25;
      // شفاء بسيط
      state.health = Math.min(state.healthMax, state.health+1);
      renderHearts();
    }

    updateHud();
    requestAnimationFrame(loop);
  }

  // إدخال لوحة المفاتيح
  const down = e=>{
    if(['ArrowLeft','a','A'].includes(e.key))  keys.left=true;
    if(['ArrowRight','d','D'].includes(e.key)) keys.right=true;
    if(['ArrowUp','w','W'].includes(e.key))    keys.up=true;
    if(['ArrowDown','s','S'].includes(e.key))  keys.down=true;
    if(e.code==='Space') keys.shoot=true;
  };
  const up = e=>{
    if(['ArrowLeft','a','A'].includes(e.key))  keys.left=false;
    if(['ArrowRight','d','D'].includes(e.key)) keys.right=false;
    if(['ArrowUp','w','W'].includes(e.key))    keys.up=false;
    if(['ArrowDown','s','S'].includes(e.key))  keys.down=false;
    if(e.code==='Space') keys.shoot=false;
  };
  window.addEventListener('keydown', down);
  window.addEventListener('keyup', up);

  // أزرار اللمس
  function bindHold(el, prop){
    const set = v=>{ keys[prop]=v; };
    const on = e=>{ e.preventDefault(); set(true); };
    const off = e=>{ e.preventDefault(); set(false); };
    el.addEventListener('pointerdown', on);
    el.addEventListener('pointerup', off);
    el.addEventListener('pointercancel', off);
    el.addEventListener('pointerleave', off);
  }
  document.querySelectorAll('[data-hold]')
    .forEach(b=>bindHold(b, b.dataset.hold));
  // زر إطلاق
  const fireBtn = document.getElementById('btnShoot');
  bindHold(fireBtn, 'shoot');

  // أزرار القائمة/الإعادة
  document.getElementById('easyBtn').onclick = ()=>{ setMode('easy'); startGame(); };
  document.getElementById('hardBtn').onclick = ()=>{ setMode('hard'); startGame(); };
  document.getElementById('retryBtn').onclick = ()=> startGame();
  document.getElementById('menuBtn').onclick  = ()=>{
    document.getElementById('controls').classList.add('hidden');
    document.getElementById('hud').classList.add('hidden');
    document.getElementById('gameover').classList.add('hidden');
    document.getElementById('menu').classList.remove('hidden');
  };

  // منع سحب الصفحة بالإيماءات
  ['touchstart','touchmove'].forEach(ev=>{
    document.body.addEventListener(ev, e=>{ if(e.target.closest('#controls')) e.preventDefault(); }, {passive:false});
  });
})();
</script>
</body>
</html>
