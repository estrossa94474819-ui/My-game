<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<title>لعبة الزومبي</title>
<style>
:root{
  --bg:#050a13; --panel:#121a30; --ui:#0d6efd; --ok:#2b8a3e; --danger:#c92a2a; --text:#e6eef7;
}
*{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Arial}
#game{display:block;width:100vw;height:100vh;background:#0a0f1d;touch-action:none}

/* HUD */
.hud{position:fixed;inset:12px 12px auto 12px;display:flex;gap:10px;z-index:5;align-items:center}
.heart{width:26px;height:22px;border:2px solid #2b3445;border-radius:4px;background:#13b36b}
.heart.warn{background:#f0c419}
.heart.crit{background:#e03131}

/* المرحلة والعدّاد */
.stage{position:fixed;top:12px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.35);border:1px solid #273449;border-radius:8px;padding:6px 10px;font-size:13px}

/* شاشة البداية/الخسارة */
.overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:6}
.card{background:var(--panel);border:1px solid #263345;border-radius:12px;padding:18px 20px;min-width:260px;text-align:center}
.title{font-weight:700;margin:0 0 8px}
.row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
.btn{pointer-events:auto;border:none;outline:0;color:#fff;background:#444;border-radius:999px;padding:10px 16px;font-weight:700}
.btn.primary{background:var(--ui)}
.small{font-size:13px;opacity:.8}

/* عناصر التحكم */
#controls{position:fixed;inset:auto 0 12px 0;display:flex;align-items:center;justify-content:center;pointer-events:none;z-index:7}
#joyArea{position:fixed;left:14px;bottom:14px;width:140px;height:140px;border:2px solid #aaa;border-radius:50%;background:rgba(255,255,255,.03);pointer-events:auto;touch-action:none}
#stick{position:absolute;left:50%;top:50%;width:64px;height:64px;margin:-32px 0 0 -32px;border:2px solid #ccc;border-radius:50%;background:rgba(255,255,255,.06)}
.btn.big{position:fixed;left:180px;bottom:28px;width:96px;height:96px;font-size:26px;border-radius:999px}
.rightCol{position:fixed;right:22px;bottom:22px;display:flex;flex-direction:column;gap:14px;pointer-events:none}
.rightCol .btn{pointer-events:auto;width:76px;height:76px;font-size:28px;border-radius:999px}
.red{background:var(--danger)}
.green{background:var(--ok)}
.weaponLabel{position:fixed;right:22px;bottom:110px;opacity:.85;font-size:12px;background:rgba(0,0,0,.35);border:1px solid #2a3548;border-radius:8px;padding:4px 8px}

/* تكبير بسيط لأجهزة كبيرة */
@media (min-width:900px){
  #joyArea{width:160px;height:160px}
  #stick{width:72px;height:72px;margin:-36px 0 0 -36px}
  .btn.big{width:110px;height:110px}
  .rightCol .btn{width:84px;height:84px}
}
</style>
</head>
<body>

<canvas id="game"></canvas>

<!-- HUD -->
<div class="hud" id="hearts"></div>
<div class="stage" id="stageBox">المرحلة: 1 • زومبي: 0/0</div>

<!-- شاشة البداية -->
<div class="overlay" id="startScreen">
  <div class="card">
    <h3 class="title">ابدأ اللعبة</h3>
    <div>حرّك بالجير، 🆙 للقفز، 🔥 للإطلاق، ⚔️ تبديل سلاح.</div>
    <div class="row"><button class="btn primary" id="btnStart">ابدأ</button></div>
    <div class="small">لوحة مفاتيح: الأسهم/AD للحركة، Space قفز، F إطلاق، Q تبديل</div>
  </div>
</div>

<!-- شاشة خسارة -->
<div class="overlay" id="gameOver" style="display:none">
  <div class="card">
    <h3 class="title">انتهت المحاولة</h3>
    <div id="summary"></div>
    <div class="row">
      <button class="btn primary" id="btnRetry">إعادة</button>
    </div>
  </div>
</div>

<!-- عناصر التحكم -->
<div id="controls">
  <div id="joyArea"><div id="stick"></div></div>
  <button id="btnShoot" class="btn big">🔥</button>
  <div class="rightCol">
    <div class="weaponLabel" id="lblWeapon">المسدس 🔫</div>
    <button id="btnSwitch" class="btn red" title="تبديل السلاح">⚔️</button>
    <button id="btnJump" class="btn green" title="قفز">🆙</button>
  </div>
</div>

<script>
/* ====== إعداد اللوحة ====== */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
addEventListener('resize', resize); resize();

/* ====== حالة اللعبة ====== */
const G = 1600;          // جاذبية
const FLOOR = 80;        // ارتفاع الأرض عن الأسفل
const enemyBaseSpeed = 40;
let last = 0, running = false;

const player = {
  x: 200, y: 0, w: 34, h: 56,
  vx: 0, vy: 0, speed: 180, jump: 520,
  dir: 1, onGround:false, hearts:3, inv:0,
  weapon:'gun', swordCooldown:0
};

let level = 1;
let toSpawn = 0, spawned = 0, killed = 0;
let bullets = [];
let enemies = [];
let obstacles = []; // حواجز
let fireTimer = null;

/* ====== الإدخال ====== */
const input = { moveX:0, shootHeld:false };
function key(e,down){
  const k = e.key.toLowerCase();
  if(['arrowleft','a'].includes(k)) { input.moveX = down ? -1 : (input.moveX<0?0:input.moveX); e.preventDefault(); }
  if(['arrowright','d'].includes(k)) { input.moveX = down ?  1 : (input.moveX>0?0:input.moveX); e.preventDefault(); }
  if([' ','arrowup','w'].includes(k) && down){ jump(); e.preventDefault(); }
  if(k==='f'){ if(down) startFire(); else stopFire(); }
  if(k==='q' && down) switchWeapon();
}
addEventListener('keydown', e=>key(e,true));
addEventListener('keyup',   e=>key(e,false));

/* ====== عناصر التحكم باللمس ====== */
function onPress(el, down, up){
  const start = (e)=>{ e.preventDefault(); down && down(e); };
  const end   = (e)=>{ e.preventDefault(); up   && up(e);   };
  el.addEventListener('touchstart', start, {passive:false});
  el.addEventListener('touchend',   end,   {passive:false});
  el.addEventListener('mousedown',  start);
  el.addEventListener('mouseup',    end);
  el.addEventListener('mouseleave', end);
}
const btnShoot  = document.getElementById('btnShoot');
const btnJump   = document.getElementById('btnJump');
const btnSwitch = document.getElementById('btnSwitch');
const lblWeapon = document.getElementById('lblWeapon');

onPress(btnShoot, ()=>startFire(), ()=>stopFire());
onPress(btnJump,  ()=>jump());
onPress(btnSwitch,()=>switchWeapon());

/* عصا الحركة */
const joyArea = document.getElementById('joyArea');
const stick   = document.getElementById('stick');
let joyActive=false;
function joyPoint(e){
  const t = (e.touches && e.touches[0]) || e;
  const r = joyArea.getBoundingClientRect();
  return { x: t.clientX - (r.left + r.width/2), y: t.clientY - (r.top + r.height/2), rad: Math.min(r.width,r.height)/2 };
}
function joyStart(e){ e.preventDefault(); joyActive=true; joyMove(e); }
function joyMove(e){
  if(!joyActive) return;
  const p = joyPoint(e), len=Math.hypot(p.x,p.y), max=p.rad-20;
  const nx = len? p.x/len : 0;
  const cl = Math.min(len,max);
  stick.style.transform = `translate(${nx*cl}px, ${0}px)`;
  input.moveX = Math.max(-1, Math.min(1, p.x / max));
}
function joyEnd(){ joyActive=false; input.moveX=0; stick.style.transform='translate(0,0)'; }
joyArea.addEventListener('touchstart', joyStart, {passive:false});
joyArea.addEventListener('touchmove',  joyMove,  {passive:false});
joyArea.addEventListener('touchend',   joyEnd);
joyArea.addEventListener('mousedown',  joyStart);
addEventListener('mousemove',          joyMove);
addEventListener('mouseup',            joyEnd);

/* ====== واجهات ====== */
const startScreen = document.getElementById('startScreen');
const gameOver = document.getElementById('gameOver');
const summary = document.getElementById('summary');
document.getElementById('btnStart').onclick = ()=>{ startScreen.style.display='none'; startGame(); };
document.getElementById('btnRetry').onclick = ()=>{ gameOver.style.display='none'; startGame(); };

/* ====== وظائف اللاعب/الأسلحة ====== */
function startFire(){
  if(player.weapon==='gun'){
    if(!fireTimer){ shootOnce(); fireTimer = setInterval(shootOnce, 180); }
  }else{ swingSword(); }
}
function stopFire(){ if(fireTimer){ clearInterval(fireTimer); fireTimer=null; } }
function switchWeapon(){
  player.weapon = (player.weapon==='gun') ? 'sword' : 'gun';
  lblWeapon.textContent = player.weapon==='gun' ? 'المسدس 🔫' : 'السيف ⚔️';
}
function jump(){
  if(player.onGround){ player.vy = -player.jump; player.onGround=false; }
}
function shootOnce(){
  const speed = 520;
  bullets.push({
    x: player.x + (player.dir>0 ? player.w : 0),
    y: player.y + player.h*0.35,
    vx: player.dir*speed, vy: 0, r: 4, life: 1.2
  });
}
function swingSword(){
  if(player.swordCooldown>0) return;
  player.swordCooldown = 0.25;
  const range = 46;
  enemies.forEach(e=>{
    if(!e.dead){
      const dx = (e.x + e.w/2) - (player.x + player.w/2);
      const dy = (e.y + e.h/2) - (player.y + player.h/2);
      if(Math.abs(dy)<40 && Math.sign(dx)===player.dir && Math.abs(dx)<range+e.w/2){
        e.hp -= 2; if(e.hp<=0) killEnemy(e);
      }
    }
  });
}

/* ====== أعداء/مراحل ====== */
function spawnEnemy(side){
  const speed = enemyBaseSpeed + level*10 + Math.random()*20;
  enemies.push({
    x: side==='L' ? -40 : canvas.width+40,
    y: 0, w: 30, h: 50,
    vx: side==='L' ? (2+Math.random())*speed : -(2+Math.random())*speed,
    vy: 0, onGround:false, hp: 2, dead:false, dir: side==='L'?1:-1
  });
  spawned++;
}
function killEnemy(e){ e.dead=true; killed++; }
function nextLevel(){
  level++;
  setupLevel();
}
function setupLevel(){
  enemies.length = 0; bullets.length=0;
  spawned = 0; killed = 0;
  toSpawn = level*10;
  // حواجز عشوائية بسيطة
  obstacles = [
    {x: canvas.width*0.30, y: canvas.height-FLOOR-24, w:120, h:24},
    {x: canvas.width*0.62, y: canvas.height-FLOOR-36, w:140, h:36}
  ];
  updateStageBox();
}

/* ====== HUD ====== */
const heartsEl = document.getElementById('hearts');
function renderHearts(){
  heartsEl.innerHTML='';
  for(let i=0;i<3;i++){
    const d = document.createElement('div');
    d.className='heart';
    if(i>=player.hearts) d.style.background='#1b2333';
    if(player.hearts===2 && i===2) d.classList.add('warn');
    if(player.hearts===1 && i>=1) d.classList.add('crit');
    heartsEl.appendChild(d);
  }
}
function updateStageBox(){
  document.getElementById('stageBox').textContent = `المرحلة: ${level} • زومبي: ${killed}/${toSpawn}`;
}

/* ====== فيزياء مبسطة ====== */
function applyPhysics(o, dt){
  o.vy += G*dt;
  o.x  += o.vx*dt;
  o.y  += o.vy*dt;

  // أرض
  const ground = canvas.height - FLOOR;
  if(o.y + o.h >= ground){
    o.y = ground - o.h;
    o.vy = 0;
    o.onGround = true;
  } else o.onGround=false;

  // حواجز (صناديق بسيطة)
  obstacles.forEach(b=>{
    // من الأعلى (الهبوط على منصة)
    if(o.vy>=0 && o.y+o.h<=b.y+20 && o.x+o.w>b.x && o.x<b.x+b.w && o.y+o.h>=b.y){
      o.y = b.y - o.h; o.vy=0; o.onGround=true;
    }
    // اصطدام جانبي بسيط
    if(o.y+o.h>b.y+2 && o.y<b.y+b.h){
      if(o.x+o.w>b.x && o.x<b.x){ o.x=b.x-o.w; if(!o.isPlayer) o.vx*=-1; }
      if(o.x<b.x+b.w && o.x+o.w>b.x+b.w){ o.x=b.x+b.w; if(!o.isPlayer) o.vx*=-1; }
    }
  });

  // حدود الشاشة
  if(o.x<0){ o.x=0; if(!o.isPlayer) o.vx=Math.abs(o.vx); }
  if(o.x+o.w>canvas.width){ o.x=canvas.width-o.w; if(!o.isPlayer) o.vx=-Math.abs(o.vx); }
}

/* ====== بدء/إعادة ====== */
function startGame(){
  player.x=200; player.y=0; player.vx=0; player.vy=0; player.dir=1;
  player.hearts=3; player.inv=0; player.weapon='gun'; player.swordCooldown=0;
  level=1; renderHearts(); lblWeapon.textContent='المسدس 🔫';
  setupLevel();
  running=true; last=performance.now();
  requestAnimationFrame(loop);
}

function gameOverNow(){
  running=false; stopFire();
  summary.textContent = `وصلت للمرحلة ${level} وقتلت ${killed} من أصل ${toSpawn}.`;
  gameOver.style.display='flex';
}

/* ====== الحلقة الأساسية ====== */
function loop(ts){
  if(!running) return;
  const dt = Math.min(0.033, (ts-last)/1000); last=ts;

  // تطبيق الإدخال
  player.vx = input.moveX * player.speed;
  if(Math.abs(input.moveX)>0.05) player.dir = input.moveX>0 ? 1 : -1;
  if(player.swordCooldown>0) player.swordCooldown -= dt;
  if(player.inv>0) player.inv -= dt;

  // سباون الزومبي
  if(spawned<toSpawn){
    // كل نصف ثانية تقريبًا
    if(Math.random()<0.02 + level*0.002){
      spawnEnemy(Math.random()<0.5?'L':'R');
    }
  }else if(killed>=toSpawn){
    nextLevel();
  }

  // فيزياء
  player.isPlayer=true;
  applyPhysics(player, dt);
  enemies.forEach(e=>{
    // قفزة صغيرة عندما يصادف حاجز أمامه
    obstacles.forEach(b=>{
      const ahead = e.dir>0 ? (e.x+e.w>=b.x-2 && e.x+e.w<=b.x+10) : (e.x<=b.x+b.w+2 && e.x>=b.x+b.w-10);
      const onSame = Math.abs((e.y+e.h) - (b.y))<4;
      if(ahead && onSame && e.onGround){ e.vy = -450 - level*20; e.onGround=false; }
    });
    // اتجاه الحركة
    e.dir = e.vx>=0 ? 1 : -1;
    // اقتراب من اللاعب قليلًا
    e.vx += Math.sign(player.x - e.x) * (10 + level) * dt;
    applyPhysics(e, dt);

    // ضرر للاعب عند التلامس
    if(!e.dead && player.inv<=0 &&
       e.x<player.x+player.w && e.x+e.w>player.x &&
       e.y<player.y+player.h && e.y+e.h>player.y){
      player.hearts--; renderHearts(); player.inv=1.0;
      if(player.hearts<=0){ gameOverNow(); }
    }
  });

  // رصاص
  bullets = bullets.filter(b=>{
    b.x += b.vx*dt; b.y += b.vy*dt; b.life -= dt;
    // اصطدام مع عدو
    for(const e of enemies){
      if(!e.dead && b.x-b.r<e.x+e.w && b.x+b.r>e.x && b.y-b.r<e.y+e.h && b.y+b.r>e.y){
        e.hp -= 1; b.life=0;
        if(e.hp<=0) killEnemy(e);
        break;
      }
    }
    return b.life>0 && b.x>-50 && b.x<canvas.width+50;
  });

  // رسم
  draw();

  updateStageBox();
  requestAnimationFrame(loop);
}

/* ====== الرسم ====== */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // أرض
  ctx.fillStyle = '#0d1224';
  ctx.fillRect(0, canvas.height-FLOOR, canvas.width, FLOOR);

  // حواجز
  ctx.fillStyle = '#24324a';
  obstacles.forEach(b=>ctx.fillRect(b.x,b.y,b.w,b.h));

  // اللاعب (رجل عصا + سيف عند السيف)
  drawStick(player.x, player.y, player.w, player.h, '#8bd1ff');
  if(player.weapon==='sword'){
    ctx.strokeStyle = '#ffdf6b';
    ctx.lineWidth = 4;
    ctx.beginPath();
    const sx = player.dir>0 ? player.x+player.w+10 : player.x-10;
    const sy = player.y+player.h*0.35;
    ctx.moveTo(sx, sy);
    ctx.lineTo(sx + (player.dir>0?24:-24), sy-12);
    ctx.stroke();
  } else {
    // مسدس بسيط
    ctx.fillStyle = '#bbb';
    const gx = player.dir>0 ? player.x+player.w-6 : player.x-10;
    ctx.fillRect(gx, player.y+player.h*0.35-4, 12, 8);
  }

  // الزومبي
  enemies.forEach(e=>{
    if(e.dead) return;
    drawStick(e.x, e.y, e.w, e.h, '#90ee90');
  });

  // الرصاص
  ctx.fillStyle = '#ffd166';
  bullets.forEach(b=>{
    ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
  });
}

/* رسم رجل عصا بسيط */
function drawStick(x,y,w,h,color){
  ctx.strokeStyle = color; ctx.lineWidth = 3;
  const headR = 10;
  // رأس
  ctx.beginPath(); ctx.arc(x+w/2, y+headR+4, headR, 0, Math.PI*2); ctx.stroke();
  // جسم
  ctx.beginPath();
  ctx.moveTo(x+w/2, y+headR*2+2);
  ctx.lineTo(x+w/2, y+h-12);
  // يدين
  ctx.moveTo(x+w/2, y+headR*2+12);
  ctx.lineTo(x+w/2 - 18, y+headR*2+24);
  ctx.moveTo(x+w/2, y+headR*2+12);
  ctx.lineTo(x+w/2 + 18, y+headR*2+24);
  // رجلين
  ctx.moveTo(x+w/2, y+h-12);
  ctx.lineTo(x+w/2-16, y+h);
  ctx.moveTo(x+w/2, y+h-12);
  ctx.lineTo(x+w/2+16, y+h);
  ctx.stroke();
}

/* ====== تهيئة HUD أولية ====== */
renderHearts();
updateStageBox();

/* بدء تلقائي عبر زر ابدأ */
</script>
</body>
</html>
